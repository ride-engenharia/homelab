- name: Wait for PostgreSQL to be ready
  ansible.builtin.wait_for:
    host: "127.0.0.1"
    port: 5432
    timeout: 30

- name: Create application databases
  community.postgresql.postgresql_db:
    name: "{{ item.name }}"
    login_host: "127.0.0.1"
    login_user: "{{ postgres_root_user }}"
    login_password: "{{ postgres_root_password }}"
  loop: "{{ databases }}"

- name: Create database users
  community.postgresql.postgresql_user:
    name: "{{ item.user }}"
    password: "{{ item.password }}"
    role_attr_flags: "NOSUPERUSER"
    login_host: "127.0.0.1"
    login_user: "{{ postgres_root_user }}"
    login_password: "{{ postgres_root_password }}"
    login_db: "postgres"
  loop: "{{ databases }}"

- name: Grant database-level privileges
  community.postgresql.postgresql_privs:
    objs: "{{ item.name }}"
    role: "{{ item.user }}"
    privs: "ALL"
    type: "database"
    login_host: "127.0.0.1"
    login_user: "{{ postgres_root_user }}"
    login_password: "{{ postgres_root_password }}"
    login_db: "postgres"
  loop: "{{ databases }}"

- name: Grant schema privileges
  community.postgresql.postgresql_privs:
    objs: "public"
    role: "{{ item.user }}"
    privs: "ALL"
    type: "schema"
    login_host: "127.0.0.1"
    login_user: "{{ postgres_root_user }}"
    login_password: "{{ postgres_root_password }}"
    login_db: "{{ item.name }}"
  loop: "{{ databases }}"

- name: Grant table privileges
  community.postgresql.postgresql_privs:
    objs: "ALL_IN_SCHEMA"
    role: "{{ item.user }}"
    privs: "ALL"
    type: "table"
    login_host: "127.0.0.1"
    login_user: "{{ postgres_root_user }}"
    login_password: "{{ postgres_root_password }}"
    login_db: "{{ item.name }}"
  loop: "{{ databases }}"

- name: Grant sequence privileges
  community.postgresql.postgresql_privs:
    objs: "ALL_IN_SCHEMA"
    role: "{{ item.user }}"
    privs: "ALL"
    type: "sequence"
    login_host: "127.0.0.1"
    login_user: "{{ postgres_root_user }}"
    login_password: "{{ postgres_root_password }}"
    login_db: "{{ item.name }}"
  loop: "{{ databases }}"
